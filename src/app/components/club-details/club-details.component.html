<div class="club-details">
  <p-toast key="error" position="bottom-right" appendTo="body" [baseZIndex]="10000"></p-toast>
  <p-toast key="success" position="top-right" appendTo="body" [baseZIndex]="10000"></p-toast>
  <p-confirmDialog appendTo="body"></p-confirmDialog>

  <ng-container *ngIf="!isLoading(); else loadingTpl">
  <form *ngIf="isEditing(); else previewBlock" [formGroup]="form" [class.submitted]="submitted" [class.saving]="isSaving()">

    <div class="section">
      <h3>Club Details</h3>
    </div>

    <div class="single-row" style="margin-top: 16px;">
      <div class="field">
        <label>Club Name</label>
        <input pInputText placeholder="Enter club name" formControlName="name" />
      </div>
    </div>

    <div class="grid email-phone-row">
      <div class="field">
        <label>Club Email</label>
        <input pInputText placeholder="Enter club email" formControlName="email" />
      </div>
      <div class="field right">
        <label>Phone Number</label>
        <input pInputText placeholder="Enter phone number" formControlName="phone" />
      </div>
    </div>

    <div class="field description-field">
      <label>Description</label>
      <textarea class="textarea" placeholder="Enter club description" formControlName="description"></textarea>
    </div>
    <hr class="section-separator" />

    <div class="section location-section">
      <h3>Club Location</h3>
      <div class="grid" style="margin-top: 12px; grid-template-columns: 1fr auto; align-items: end;">
        <div class="field">
          <label>Enter address</label>
          <input pInputText placeholder="Start typing an address" formControlName="address" />
        </div>
        <div class="field right" style="display: flex; justify-content: flex-end; align-items: center;">
          <label class="sr-only">Add Location</label>
          <button type="button" class="btn btn--primary" (click)="onAddLocation()">Add location</button>
        </div>
      </div>

      <div #mapContainer class="map" aria-label="Location map" [class.invalid]="submitted && savedLocations.length === 0"></div>

      <div class="saved-locations" *ngIf="savedLocations.length > 0">
        <div class="loc-card" *ngFor="let loc of savedLocations; let i = index">
          <div class="loc-main">
            <div class="loc-title">{{ loc.address }}</div>
            <div class="loc-sub">{{ loc.lat | number:'1.5-5' }}, {{ loc.lng | number:'1.5-5' }}</div>
          </div>
          <button type="button" class="btn btn--danger" (click)="removeLocation(i)">Remove</button>
        </div>
      </div>
      <div class="error-text" *ngIf="submitted && savedLocations.length === 0">Please add at least one location.</div>
    </div>

    <hr class="section-separator" />

    <div class="section">
      <h3>Select Sport Category</h3>
      <div class="sports">
        <button *ngFor="let s of sports" type="button" [class.active]="isSelected(s)" (click)="toggleSportSelection(s)">
          <div class="sport-icon" [ngSwitch]="s">
            <img *ngSwitchCase="'tennis'" src="assets/icons/tennis.png" alt="Tennis" />
            <img *ngSwitchCase="'padel'" src="assets/icons/padel.png" alt="Padel" />
            <img *ngSwitchCase="'football'" src="assets/icons/football.png" alt="Football" />
            <img *ngSwitchCase="'basketball'" src="assets/icons/basketball.png" alt="Basketball" />
            <img *ngSwitchCase="'volleyball'" src="assets/icons/volleyball.png" alt="Volleyball" />
            <img *ngSwitchCase="'badminton'" src="assets/icons/badminton.png" alt="Badminton" />
            <img *ngSwitchCase="'squash'" src="assets/icons/squash.png" alt="Squash" />
            <img *ngSwitchCase="'pingpong'" src="assets/icons/pingpong.png" alt="Ping Pong" />
            <img *ngSwitchCase="'handball'" src="assets/icons/handball.png" alt="Handball" />
            <img *ngSwitchDefault src="assets/icons/tennis.png" alt="Sport" />
          </div>
          <div class="label">{{ labelFromKey(s) }}</div>
        </button>
      </div>
    </div>

    <hr class="section-separator" />
    <div class="section">
      <h3>Club Media</h3>
      <div class="media-grid">
        <div class="media-card">
          <div class="title">Club Profile Picture</div>
          <div class="drop clickable profile"
               (click)="onClickProfileUpload()"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               (drop)="onProfileDrop($event)"
               [class.drag-over]="isDragOverProfile()"
               [class.invalid]="submitted && !profilePreviewUrl()">
            <input type="file" accept="image/*" hidden #profileInput (click)="$event.stopPropagation()" (change)="onProfileSelected($event)" />

            <ng-container *ngIf="isUploadingProfile(); else profileContent">
              <div class="u-spinner u-spinner--lg text-green" aria-label="Uploading"></div>
              <div class="drop-sub">Uploading...</div>
            </ng-container>
            <ng-template #profileContent>
              <ng-container *ngIf="profilePreviewUrl(); else profilePlaceholder">
                <img class="preview" [src]="profilePreviewUrl()" alt="Profile preview" (click)="$event.stopPropagation()" />
                <div class="overlay-actions" (click)="$event.stopPropagation()">
                  <button type="button" class="icon-btn" title="Edit image" (click)="onEditProfileImage($event)">
                    <img src="assets/icons/edit.png" alt="Edit" />
                  </button>
                  <button type="button" class="icon-btn danger" title="Delete image" (click)="onDeleteProfileImage($event)">
                    <img src="assets/icons/trash.png" alt="Delete" />
                  </button>
                </div>
              </ng-container>
              <ng-template #profilePlaceholder>
                <div class="drop-emoji"><img src="assets/icons/photo.png" alt="Upload" /></div>
                <div class="drop-title">Upload Profile Picture</div>
                <div class="drop-sub">Click to browse or drag & drop</div>
              </ng-template>
            </ng-template>
          </div>
        </div>
        <div class="media-card">
          <div class="title">Club Wallpaper</div>
          <div class="drop clickable wallpaper"
               (click)="onClickWallpaperUpload()"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               (drop)="onWallpaperDrop($event)"
               [class.drag-over]="isDragOverWallpaper()"
               [class.invalid]="submitted && !wallpaperPreviewUrl()">
            <input type="file" accept="image/*" hidden #wallpaperInput (click)="$event.stopPropagation()" (change)="onWallpaperSelected($event)" />

            <ng-container *ngIf="isUploadingWallpaper(); else wallpaperContent">
              <div class="u-spinner u-spinner--lg text-green" aria-label="Uploading"></div>
              <div class="drop-sub">Uploading...</div>
            </ng-container>
            <ng-template #wallpaperContent>
              <ng-container *ngIf="wallpaperPreviewUrl(); else wallpaperPlaceholder">
                <img class="preview wide" [src]="wallpaperPreviewUrl()" alt="Wallpaper preview" (click)="$event.stopPropagation()" />
                <div class="overlay-actions" (click)="$event.stopPropagation()">
                  <button type="button" class="icon-btn" title="Edit image" (click)="onEditWallpaperImage($event)">
                    <img src="assets/icons/edit.png" alt="Edit" />
                  </button>
                  <button type="button" class="icon-btn danger" title="Delete image" (click)="onDeleteWallpaperImage($event)">
                    <img src="assets/icons/trash.png" alt="Delete" />
                  </button>
                </div>
              </ng-container>
              <ng-template #wallpaperPlaceholder>
                <div class="drop-emoji"><img src="assets/icons/photo.png" alt="Upload" /></div>
                <div class="drop-title">Upload Wallpaper</div>
                <div class="drop-sub">Click to browse or drag & drop</div>
              </ng-template>
            </ng-template>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="hint">Make sure all information is accurate before saving</div>
      <button pButton type="button" (click)="save()" class="btn btn--primary btn--sm" [disabled]="isSaving()">
        <ng-container *ngIf="isSaving(); else normalContent">
          <span class="u-spinner u-spinner--sm"></span>
          <span>{{ hasExistingClub ? 'Updating Club...' : 'Creating Club...' }}</span>
        </ng-container>
        <ng-template #normalContent>
          <span>{{ hasExistingClub ? 'Update Club' : 'Create Club' }}</span>
        </ng-template>
      </button>
    </div>
  </form>

  <ng-template #previewBlock>
    <ng-container *ngIf="clubService.lastSaved() as saved; else noData">
      <app-club-preview [details]="saved" (editRequested)="startEdit()" (editCourtsRequested)="onEditCourtsRequested()" (deleteRequested)="onDeleteClub()" (manageBookingRequested)="onManageBooking($event)"></app-club-preview>
    </ng-container>
    <ng-template #noData>
      <div class="no-data">
        <div class="preview-title">No club saved yet</div>
        <button type="button" class="btn btn--primary" (click)="startEdit()">Create Club</button>
      </div>
    </ng-template>
  </ng-template>
  </ng-container>

  <ng-template #loadingTpl>
    <div class="center-loading" aria-busy="true" aria-live="polite">
      <div class="u-spinner u-spinner--xl text-green"></div>
    </div>
  </ng-template>
</div>
